/*! bh-lay.com 2014-06-07 */
define(function(a,b){function c(a,b){for(var c=b.length,d=0;c>d;d++)if(b[d].fullname==a)return b[d]}function d(a,b){$.ajax({url:"/ajax/asset",type:"GET",data:{path:a},dataType:"json",success:function(a){if(a&&200==a.code){var c={dir:[],files:[]};for(var d in a.files){a.files[d].isdir?c.dir.push({name:a.files[d].name,type:"folder"}):c.files.push({name:a.files[d].name})}b&&b(null,c)}else b&&b("网络出错！")}})}function e(){var a=this,b=new g({dom:this.dom.find('a[data-action="upload"]'),action:"/ajax/asset/upload",data:{act:"addFile",root:"/"}});this.on("fresh",function(a){b.data.root=a}),b.responseParser=function(a){return files=a&&a.code&&200==a.code?a.files:[],{files:files}},b.on("startUpload",function(b,c){console.log(arguments);for(var d in c){var e=new k(a.root,{name:c[d].name});a.files.push(e),a.cntDom.append(e.dom)}}),b.on("success",function(){}),this.dom.on("click",".gP_dir_item",function(){var b=$(this).parents(".gP_item").attr("data-fullname");a.open(b)}).on("click",'a[data-action="createDir"]',function(){j.ask("新目录叫什么呢？",function(b){a.createDir(b)})}).on("click",'a[data-action="back"]',function(){a.back()}).on("click",'a[data-action="changeLayout"]',function(){a.layout()});var c=i({targets:".gP_cnt"});c.add("mkdir",{txt:"新建目录"},function(){j.ask("新目录叫什么呢？",function(b){a.createDir(b)})});var c=i({targets:'.gP_item[data-type="file"]',callback:function(a){console.log('you have chioce "',a,'" from the [ ',this,"]")},callbefore:function(){}});c.type="menu",c.add("rename",{txt:"重命名"},function(){var b=$(this).attr("data-fullname"),c=a.get(b,"file");c&&c.rename()}),c.add("delete",{txt:"删除"},function(){var b=$(this).attr("data-fullname"),c=a.get(b,"file");c&&c.del()});var d=i({targets:'.gP_item[data-type="folder"]',callback:function(a){console.log('you have chioce "',a,'" from the [ ',this,"]")},callbefore:function(){}});d.type="menu",d.add("open",{txt:"打开"},function(){var b=$(this).attr("data-fullname");a.open(b)}),d.add("rename",{txt:"重命名"},function(){var b=$(this).attr("data-fullname"),c=a.get(b,"folder");c&&c.rename()}),d.add("delete",{txt:"删除"},function(){var b=$(this).attr("data-fullname"),c=a.get(b,"folder");c&&c.del()})}function f(a){this.root="/",this.dom=$(o),this._layout="colum",this.cntDom=this.dom.find(".gp_select_cnt"),this.pathDom=this.dom.find(".gP_rootNav"),this.folders=[],this.files=[],a.html(this.dom),h.extend.call(this),e.call(this),this.open(""),this.layout("colum")}a("/frontEnd/gallery/style.css");var g=a("/frontEnd/util/uploader.js"),h=a("/frontEnd/util/event.js"),i=a("/frontEnd/util/panel.js"),j=a("/frontEnd/UI/pop.js"),k=a("/frontEnd/gallery/fileItem.js"),l=a("/frontEnd/gallery/folderItem.js"),m='<div class="gp_loading">正在加载</div>',n='<div class="gp_loading">傻逼，建个空目录做啥子！</div>',o=['<div class="gP_select">','<div class="gp_toolBar">','<div class="gp_toolBar_left">','<a href="javascript:void(0)" data-action="back"><span class="glyphicon glyphicon-chevron-left"></span></a>','<a href="javascript:void(0)" data-action="createDir"><span class="glyphicon glyphicon-folder-close"></span></a>','<a href="javascript:void(0)" data-action="upload"><span class="glyphicon glyphicon-cloud-upload"></span></a>',"</div>",'<span class="gP_rootNav">/</span>','<div class="gp_toolBar_right">','<a href="javascript:void(0)" data-action="changeLayout">','<div class="changeLayout layoutColum">','<div class="span1"></div><div class="span2"></div>','<div class="span3"></div><div class="span4"></div>','<div class="span5"></div><div class="span6"></div>',"</div>","</a>","</div>","</div>",'<div class="gp_select_cnt gp_select_colum"></div>',"</div>"].join(""),p=['<div class="galleryPop">','<div class="galleryPop_cnt"><div class="container bs-docs-container"><div class="row">','<div class="col-md-12"></div>',"</div></div></div>",'<div class="galleryPop_footer">','<a href="javascript:void(0)">确定</a>',"</div>","</div>"].join("");f.prototype={open:function(a){var b=this.root+"/"+a;b=b.replace(/\/+/g,"/"),b=b.length>0?b:"/",this.jump(b)},layout:function(a){var b="";b=a&&a.match(/^grid|colum$/)?a:"colum"==this._layout?"grid":"colum",this._layout=b;var c=this.dom.find(".changeLayout"),d=this.dom.find(".gp_select_cnt");"colum"==this._layout?(c.removeClass("layoutGrid"),c.addClass("layoutColum"),d.addClass("gp_select_colum"),d.removeClass("gp_select_grid")):(c.addClass("layoutGrid"),c.removeClass("layoutColum"),d.removeClass("gp_select_colum"),d.addClass("gp_select_grid"))},createDir:function(a,b){var c=this;return!a||a.length<0?void(b&&b("参数不全")):void $.ajax({url:"/ajax/asset/createDir",type:"POST",data:{root:this.root,name:a},dataType:"json",success:function(a){c.refresh(),b&&b(null,a)},error:function(){b&&b("网络出错")}})},get:function(a,b){var d=!1;if(a&&a.length>0){var b=b||"";if("file"==b)d=c(a,this.files);else if("folder"==b)d=c(a,this.folders);else{var e=this.files.concat(this.folders);d=c(a,e)}}return d},back:function(){var a=this.root,b=a.split("/");b.pop();var c=b.join("/");c!=a&&this.jump(c)},refresh:function(){var a=this.root;this.jump(a)},jump:function(a){var b=this,c=this.cntDom;c.html(m),this.pathDom.html(a),d(a,function(d,e){if(d)return void c.html("错啦！");if(e.dir.length+e.files.length>0){c.html(""),b.folders=[],b.files=[];for(var f in e.dir){var g=new l(a,{name:e.dir[f].name});c.append(g.dom),b.folders.push(g)}for(var f in e.files){var h=new k(a,{name:e.files[f].name});c.append(h.dom),b.files.push(h)}}else c.html(n);b.root=a,b.emit("fresh",b.root)})},selection:function(){for(var a=[],b=this.files.length,c=0;b>c;c++)"selected"==this.files[c].status&&a.push({extension:this.files[c].extension,fullname:this.files[c].fullname,url:this.files[c].url});return a}},b.init=function(a,b){return new f(a,b)},b.pop=function(a){var b=j.cover({title:"选择文件",html:p}),c=new f(b.cntDom.find(".col-md-12"));b.dom.find(".galleryPop_footer a").on("click",function(){a&&a(c.selection()),b.close()})}});