/*! bh-lay.com 2014-06-17 */
define(function(a){function b(a,b){var c='<span class="glyphicon glyphicon-file"></span>';b.extension.match(/^\.(jpg|gif|bmp|jpeg|png)$/i)?c='<span class="glyphicon glyphicon-picture"></span>':b.extension.match(/^\.(zip|rar|tar)$/i)&&(c='<span class="glyphicon glyphicon-compressed"></span>'),b.ico=c;var d="";return d+=a.replace(/{(\w*)}/g,function(){var a=arguments[1];return b[a]||""})}function c(a,b,c){var a=a||"",d=a.match(/(.*)\.(\w+)$/),e=d?d[1]:a,f=d?"."+d[2]:"",g="/"+b+"/"+a;g=g.replace(/\/+/g,"/"),c=c.replace(/\/$/,"");var h=c+g;return{fullname:a,filename:e,extension:f,pathname:g,url:h}}function d(a,b){$.ajax({url:"/ajax/asset/del",type:"POST",data:{path:a},dataType:"json",success:function(a){b&&b(null,a)},error:function(){b&&b("网络出错")}})}function e(){var a=this,b=this.dom;b.on("click",'a[data-action="del"]',function(){a.del()}).on("click",'a[data-action="rename"]',function(){a.rename()}).on("click",".gP_item_toolBar",function(){b.hasClass("gP_item_menuing")?b.removeClass("gP_item_menuing"):(b.removeClass("gP_item_menuing"),b.addClass("gP_item_menuing"))}).on("click",".gP_item_check",function(){a.select()});var c=g(b.find(".gP_item_body")[0]);c.on("swipeLeft",function(){b.find(".gP_item_body").animate({left:-100},80)}).on("swipeRight",function(){b.find(".gP_item_body").animate({left:0},80)}).on("longTap",function(){a.select()})}function f(a,d){this._status=d.status||"normal",this.fullname=d.name;var f=c(this.fullname,a,"http://asset.bh-lay.com/");this.filename=f.filename,this.extension=f.extension,this.pathname=f.pathname,this.url=f.url;var g=b(i,{fullname:this.fullname,filename:this.filename,extension:this.extension});this.dom=$(g),e.call(this),this.status(this._status)}var g=(a("/frontEnd/util/event.js"),a("/frontEnd/util/panel.js"),a("/frontEnd/util/toucher.js")),h=a("/frontEnd/UI/pop.js"),i=['<div class="gP_item" data-type="file" data-fullname="{fullname}" >','<div class="gP_item_body">','<div class="gP_file_item">','<div class="gP_file-ico">{ico}</div>','<div class="gP_file-name" title="{fullname}" ><strong>{filename}</strong><span>{extension}</span></div>',"</div>",'<div class="gP_item_tools">','<div class="gP_item_toolsCnt">','<a href="javascript:void(0)" class="gP_tool_btn" data-action="del">','<span class="gP_tool_btn_ico"><span class="glyphicon glyphicon-trash"></span></span>','<strong class="gP_tool_btn_name">删除</strong>',"</a>",'<a href="javascript:void(0)" class="gP_tool_btn" data-action="rename">','<span class="gP_tool_btn_ico"><span class="glyphicon glyphicon-pencil"></span>','<strong class="gP_tool_btn_name">重命名</strong>',"</a>","</div>","</div>",'<a href="javascript:void(0)" class="gP_item_toolBar"><span class="glyphicon glyphicon-chevron-down"></span></a>','<a href="javascript:void(0)" class="gP_item_check"><span class="glyphicon glyphicon-unchecked"></span><span class="glyphicon glyphicon-check"></span></a>',"</div>","</div>"].join("");return f.prototype={status:function(a){var b=!0;"uploading"==a?this.dom.addClass("gP_item_uploading"):"normal"==a?(this.dom.removeClass("gP_item_uploading"),this.dom.removeClass("gP_item_menuing"),this.dom.removeClass("gP_item_checked")):b=!1,b&&(this._status=a)},del:function(){var a=this.pathname,b=this.dom;h.confirm({text:"删除就找不回来了，你再想想？",callback:function(){d(a,function(a){return a?void h.prompt(a):(b.addClass("gP_item_deleted"),b.css({position:"relative",height:b.find(".gP_item_body").height(),background:"#333"}),void b.find(".gP_item_body").css({position:"absolute",width:"100%",height:"100%"}).animate({left:"100%"},300,function(){b.slideUp(120,function(){b.remove()})}))})}})},rename:function(a){var b=this,c=h.ask("快想一个新名字！",function(c){var d=c;$.ajax({url:"/ajax/asset/rename",type:"POST",data:{pathname:b.pathname,newName:d},dataType:"json",success:function(c){if(c&&200==c.code){b.filename=d,b.fullname=b.filename+b.extension;var e=b.dom.find(".gP_file-name");e.find("strong").html(b.filename),e.attr("title",b.fullname),a&&a(null,c)}else h.prompt("重命名失败"),a&&a("重命名失败")},error:function(){a&&a("网络出错")}})});c.setValue(this.filename)},select:function(){"selected"==this._status?(this._status="normal",this.dom.removeClass("gP_item_checked")):(this._status="selected",this.dom.addClass("gP_item_checked"))}},f});