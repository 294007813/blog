/*! bh-lay.com 2014-06-07 */
window.util=window.util||{},function(exports){function iframe_load(a,b){a.attachEvent?a.attachEvent("onload",function(){b&&b.call(a.contentDocument)}):a.onload=function(){b&&b.call(a.contentDocument)}}function buildDom(){var a=this,b="",c=this.data;for(var d in c)b+=input_tpl.replace(/{(\w*)}/g,function(a,b){return"name"==b?d:"value"==b?c[d]:void 0});var e=up_tpl.replace(/{(\w*)}/g,function(c,d){return"ID"==d?a.ID:"action"==d?a.action:"fileinputname"==d?a.fileinputname:"data"==d?b:void 0});return $(e)}function getFilesFromInput(a){var b=[];if(a.value.length>0)if(a.files)for(var c=0,d=a.files.length;d>c;c++)b.push({name:a.files[c].name,size:a.files[c].size});else b.push({name:a.value.split(/\\/).pop()});return b}function parseJSON(input){input=input.replace(/<[^>]+>|<\/[^>]+>/g,"");var output={};try{output=eval("("+input+")")}catch(e){output="fail"}return output}function SingleUp(a){var b=this;this.ID=++staticID,this.action=a.action,this.data=a.data||{},this.status="wait",this.responseParser=a.responseParser||null,this.fileinputname=a.fileinputname||"photos",this.beforeUpload=a.beforeUpload||null,this.onStartUpload=a.onStartUpload||null,this.onFail=a.onFail||null,this.onSuccess=a.onSuccess||null,this.dom=buildDom.call(this),global_cnt.append(this.dom),setTimeout(function(){b.init()},100)}function bindEventsForUploader(){function a(){var a=$(this);b.createSingleUp(a)}var b=this;this.dom[0].addEventListener&&private_isSupportTouch?this.dom.each(function(){var b=$(this)[0];b.addEventListener("touchstart",a),b.addEventListener("MSPointerDown",a),b.addEventListener("pointerdown",a)}):this.dom.mouseenter(a),this.dom.mouseleave(function(){b.activeSet&&b.activeSet.destory()}).on("click",function(){b.activeSet.dom.find(".uploader_btn").trigger("click")})}function uploader(a){var b=this,a=a||{};this._events={},this.action=a.action||null,this.data=a.data||{},this.dom=a.dom,this.fileinputname=a.fileinputname||"photos",this.can_upload=!0,this.responseParser=a.responseParser||null,this.activeSet=null,setTimeout(function(){bindEventsForUploader.call(b)},200)}var staticID=0,upCnt_tpl=['<div class="uploaderCnt" style="width:0px;height:0px;position:fixed;left:0px;top:0px;overflow:hidden"></div>'].join(""),up_tpl=['<div class="uploaderItem uploader{ID}">','<iframe id="uploader{ID}" name="uploader{ID}" width="0" height="0" src="about:blank"></iframe>','<form method="post" action="{action}" enctype="multipart/form-data" name="uploader" target="uploader{ID}">','<input name="{fileinputname}" type="file" multiple="multiple" class="uploader_btn" title="请选择图片"/>',"{data}","</form>","</div>"].join(""),input_tpl='<input type="hidden" name="{name}" value="{value}" />',global_cnt=$(upCnt_tpl);$(function(){$("body").append(global_cnt)});var private_isSupportTouch="ontouchend"in document?!0:!1;SingleUp.prototype.destory=function(){"wait"==this.status?this.dom.remove():this.dom.hide()},SingleUp.prototype.handleResponse=function(a){var b=this.ID;if(this.status="wait",this.responseParser){var c=parseJSON(a);if("fail"==c)this.onFail&&this.onFail(b,"服务器数据异常！");else{var d=this.responseParser(c);"object"!=typeof d?this.onFail&&this.onFail(b):d.files&&d.files.length>0?this.onSuccess&&this.onSuccess(b,d.files,d.extra):this.onFail&&this.onFail(b,d.extra)}}else this.onFail&&this.onFail(b,"you need define method : responseParser! ");this.destory()},SingleUp.prototype.init=function(){var a=this,b=this.dom,c=this.dom.find("iframe")[0],d=this.ID;b.on("change",".uploader_btn",function(){var c=this,e=!0,f=getFilesFromInput(c);f.length>0&&(e=a.beforeUpload?a.beforeUpload(d,f):!0,e?(b.hide(),$(this).parents("form").submit(),a.status="uploading",a.onStartUpload&&a.onStartUpload(d,f)):c.outerHTML=c.outerHTML)}),iframe_load(c,function(){var b=this.body.innerHTML;a.handleResponse(b)})},uploader.prototype={on:function(a,b){return this._events[a]||(this._events[a]=[]),this._events[a].push(b),this},emit:function(a,b){if(this._events[a]){b=b||null;for(var c=0,d=this._events[a].length;d>c;c++)this._events[a][c].apply(this.event_global||this,b)}},createSingleUp:function(){var a=this;this.activeSet=new SingleUp({action:this.action,data:this.data,responseParser:this.responseParser,beforeUpload:function(b,c){return a.emit("beforeUpload",[b,c]),a.can_upload?!0:!1},onStartUpload:function(b,c){a.emit("startUpload",[b,c])},onSuccess:function(b,c,d){a.emit("success",[b,c,d])},onFail:function(b,c){a.emit("error",[b,c])}})}},exports.uploader=uploader}(window.util),window.define&&define(function(){return window.util.uploader});