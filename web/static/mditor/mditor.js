/*! bh-lay.com 2014-06-07 */
window.mditor=window.mditor||{},function(a){function b(){var a=parseInt(this._textarea.parent().width()),b=parseInt(this._textarea.parent().height()),c=2*parseInt(this._textarea.css("paddingLeft")),d=2*parseInt(this._textarea.css("paddingTop"));this._textarea.css({width:a-c,height:b-d})}function c(a,b,c){var c=c||{},d=c.onInsert||null,e=c.exception||null;a&&b&&a.on("click","a",function(){var a=$(this).attr("data-btn");switch(a){case"bold":txt="**粗粗的文字**",b.insertTxt(txt).focus(2,5),d&&d(txt);break;case"italic":txt="*斜斜的文字*",b.insertTxt(txt).focus(1,5),d&&d(txt);break;case"link":txt="[这是内容](http://)",b.insertTxt(txt).focus(1,4),d&&d(txt);break;case"image":txt="![这是标题](http://)",b.insertTxt(txt).focus(2,4),d&&d(txt);break;case"code":txt="\n\n```javascript\n\n```\n\n",b.insertTxt(txt).focus(5,10),d&&d(txt);break;default:if(!e)return;var c=e(a);"string"==typeof c&&(b.insertTxt(c).focus(2,5),d&&d(c))}})}function d(a){if(!h){var d,f=this,a=a||{};a.editFor?(this.edit_for=a.editFor,d=this.edit_for.val()):d=a.content||"",d.length<2&&e.getItem("mditor")&&(d=e.getItem("mditor"));var i=g.replace("{content}",d);this.dom=$(i),this._textarea=this.dom.find("textarea"),this._view=this.dom.find(".md_html"),this.closeFn=a.closeFn||null,$("body").append(this.dom),this.render(),b.call(this),h=this;var j;this._textarea.on("keydown keyup",function(){clearTimeout(j),j=setTimeout(function(){f.render()},100)}),c(this.dom.find(".mditor_toolBar"),this._textarea,{onInsert:function(){f.render()},exception:function(a){if("exist_fullscreen"==a)f.close();else if("preview"==a){var b=f.dom.find(".mditor_view");"none"==b.css("display")?b.show():b.hide()}}})}}var e=window.localStorage||{getItem:function(){},setItem:function(){}},f=['<div class="mditor_miniBar">','<a href="javascript:void(0)" title="加粗" data-btn="bold"><i class="icon-bold"></i></a>','<a href="javascript:void(0)" title="斜体" data-btn="italic" ><i class="icon-italic"></i></a>','<a href="javascript:void(0)" title="链接" data-btn="link"><i class="icon-link"></i></a>','<a href="javascript:void(0)" title="图片" data-btn="image"><i class="icon-image"></i></a>','<a href="javascript:void(0)" title="代码" data-btn="code"><i class="icon-code"></i></a>','<a href="javascript:void(0)" title="撤销"><i class="icon-undo"></i></a>','<a href="javascript:void(0)" title="重做"><i class="icon-redo"></i></a>','<a href="javascript:void(0)" title="全屏" data-btn="fullscreen" style="float: right;"><i class="icon-fullscreen"></i></a>',"</div>"].join(""),g=['<div class="mditor_fullScreen">','<div class="mditor_toolBar">','<div class="mditor_tool_side">','<a href="javascript:void(0)" title="预览" data-btn="preview" class="mditor_preview"><i class="icon-view"></i></a>','<a href="javascript:void(0)" title="退出全屏" data-btn="exist_fullscreen"><i class="icon-exist_fullscreen"></i></a>',"</div>",'<div class="mditor_tool_main">','<a href="javascript:void(0)" title="加粗" data-btn="bold"><i class="icon-bold"></i></a>','<a href="javascript:void(0)" title="斜体" data-btn="italic" ><i class="icon-italic"></i></a>','<a href="javascript:void(0)" title="链接" data-btn="link"><i class="icon-link"></i></a>','<a href="javascript:void(0)" title="图片" data-btn="image"><i class="icon-image"></i></a>','<a href="javascript:void(0)" title="代码" data-btn="code"><i class="icon-code"></i></a>','<a href="javascript:void(0)" title="撤销"><i class="icon-undo"></i></a>','<a href="javascript:void(0)" title="重做"><i class="icon-redo"></i></a>',"</div>","</div>",'<div class="mditor_main">','<div class="mditor_input">',"<textarea>{content}</textarea>","</div>",'<div class="mditor_view">','<div class="mditor_viewer"><div class="md_html"></div></div>',"</div>","</div>","</div>"].join(""),h=null,i=document.createElement("link");i.type="text/css",i.rel="stylesheet",i.href="/frontEnd/mditor/mditor.css",document.getElementsByTagName("head")[0].appendChild(i);var j=document.createElement("link");j.type="text/css",j.rel="stylesheet",j.href="/frontEnd/lib/showdown/style-0.6.4.min.css",document.getElementsByTagName("head")[0].appendChild(j);var k=document.createElement("script");k.type="text/javascript",k.src="/frontEnd/lib/showdown/showdown.js",document.getElementsByTagName("head")[0].appendChild(k);var l=document.createElement("script");l.type="text/javascript",l.src="/frontEnd/util/selection.js",document.getElementsByTagName("head")[0].appendChild(l),$(window).resize(function(){h&&b.call(h)}),d.prototype={getContent:function(){var a=this._textarea.val();return e.setItem("mditor",a),a},getHtml:function(){console.log("refresh");var a=this.getContent(),b=new Showdown.converter,c=b.makeHtml(a);return c},render:function(){var a=this.getHtml();this._view.html(a)},close:function(){h=null,this.closeFn&&this.closeFn(this.getContent()),this.dom.remove()}},a.create=function(){return new d},a.bind=function(a){a.each(function(){var a=$(this),b=$(f);a.before(b),c(b,a,{exception:function(b){"fullscreen"==b&&new d({editFor:a,closeFn:function(b){a.val(b)}})}})})}}(window.mditor);